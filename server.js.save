const express = require('express');
const cors = require('cors');
const { GoogleGenerativeAI } = require('@google/generative-ai');
require('dotenv').config();

const app = express();
const port = 3000;

// ConfiguraÃ§Ãµes bÃ¡sicas de seguranÃ§a e comunicaÃ§Ã£o
app.use(cors());
app.use(express.json());

// Esta linha diz ao servidor para mostrar o seu site (HTML, CSS, JS, MP3) que ficarÃ¡ na pasta "public"
app.use(express.static('public')); 

// Conectando com o Google Gemini usando a chave escondida no .env
const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GEMINI_API_KEY);

// Rota (Backend) que o seu Frontend vai chamar quando o usuÃ¡rio fizer a pergunta
app.post('/api/tarot', async (req, res) => {
    try {
        const { pergunta, cartas } = req.body; // Recebe as informaÃ§Ãµes do seu HTML

        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        // O comando exato que a IA vai receber, garantindo a oraÃ§Ã£o e o tom mÃ­stico
        const prompt = `
        VocÃª Ã© um orÃ¡culo de tarot mÃ­stico e sÃ¡bio.
        O consulente fez a seguinte pergunta: "${pergunta}".
        As cartas sorteadas pelo destino foram: ${cartas.join(', ')}.
        
        Sua tarefa:
        1. Inicie a sua resposta SEMPRE com a oraÃ§Ã£o do Pai Nosso.
        2. Em seguida, interprete o significado dessas cartas de forma profunda, poÃ©tica e mÃ­stica para responder Ã  pergunta.
        3. Responda em portuguÃªs do Brasil (PT-BR).
        `;

        const result = await model.generateContent(prompt);
        const respostaIA = result.response.text();

        // Devolve a resposta pronta para o seu site
        res.json({ resposta: respostaIA });
        
    } catch (error) {
        console.error("Erro ao ler as cartas:", error);
        res.status(500).json({ erro: "As energias estÃ£o turvas no momento. Tente novamente." });
    }
});

// Liga o servidor
app.listen(port, () => {
    console.log(`ğŸ”® Servidor mÃ­stico do Tarot estÃ¡ rodando!`);
    console.log(`Acesse o seu site em: http://localhost:${port}`);
